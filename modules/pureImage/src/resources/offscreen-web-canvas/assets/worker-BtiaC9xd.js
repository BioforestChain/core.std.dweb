var P=r=>{throw TypeError(r)};var $=(r,e,n)=>e.has(r)||P("Cannot "+n);var u=(r,e,n)=>($(r,e,"read from private field"),n?n.call(r):e.get(r)),v=(r,e,n)=>e.has(r)?P("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,n),C=(r,e,n,c)=>($(r,e,"write to private field"),c?c.call(r,n):e.set(r,n),n);function S(r){if(typeof window!="object")return{toMainChannel:self,isWorker:!0};{let e=document.currentScript;if(e||document.querySelectorAll("script[data-worker-id]").forEach(l=>{l.src==r&&(e=l)}),!e)throw new Error(`no found script: ${r}`);const n=e.dataset.workerId;delete e.dataset.workerId;const c=Reflect.get(window,n);return Reflect.deleteProperty(window,n),{toMainChannel:c.toMainPort,isWorker:!1}}}const F=r=>new Promise(e=>setTimeout(e,r));var d,m;class O{constructor(e=5e3){v(this,d,new Map);v(this,m,!0);this.halfFadeInternal=e,(async()=>{let n=Date.now();for(;u(this,m);){const c=Date.now(),l=c-n;for(const[w,f]of u(this,d))f.time+=l,f.hot>>=f.time/this.halfFadeInternal,f.time%=this.halfFadeInternal,f.hot===0&&u(this,d).delete(w);n=c,await F(500)}})()}set(e,n){const c=u(this,d).get(e)||{time:0,hot:0,value:n};return c.hot+=2**10,u(this,d).set(e,c),this}get(e){return u(this,d).get(e)?.value}getOrPut(e,n){if(u(this,d).has(e))return u(this,d).get(e).value;const c=n(e);return this.set(e,c),c}delete(e){return u(this,d).delete(e)}destroy(){C(this,m,!1),u(this,d).clear()}}d=new WeakMap,m=new WeakMap;const D=typeof Promise.withResolvers=="function"?Promise.withResolvers.bind(Promise):Promise.withResolvers=function(){var e,n,c=new Promise(function(l,w){e=l,n=w});return{resolve:e,reject:n,promise:c}},j=(r,e)=>{const n=r.width/r.height,c=e.width/n;let l=e.width,w=c;return w>e.height&&(l=e.height*n,w=e.height),{width:l,height:w}},E=(()=>{try{return!navigator.userAgentData.mobile}catch{return!1}})(),M=(r,e)=>{if("convertToBlob"in r)return r.convertToBlob();if(E&&"toDataURL"in r)return fetch(r.toDataURL(e?.type,e?.quality)).then(n=>n.blob());if("toBlob"in r)return new Promise((n,c)=>{r.toBlob(l=>{l?n(l):c("fail to blob")},e?.type,e?.quality)});throw new Error("fail to convertToBlob")},{toMainChannel:W}=S(import.meta.url);(async()=>{let r=null,e=null;const n=await new Promise(t=>W.addEventListener("message",o=>{const{canvasList:a,width:i,height:s,wsUrl:h,proxyUrl:y}=o.data;a.forEach(p=>{p.width=i,p.height=s}),t(a),r=h||null,e=y||null},{once:!0})),c=t=>{if(!e||/^(data|blob):/.test(t))return t;const o=new URL(e);return o.searchParams.set("url",t),o.href},l=t=>{let o,a=!0;const i=new Image;o=i;const s=D();return(async()=>{const h=await fetch(t);if(h.ok)i.src=URL.createObjectURL(await h.blob()),i.onload=s.resolve,i.onerror=s.reject;else try{s.reject(`FETCH ERROR:[${h.status}] ${h.statusText}
${await h.text()}`)}catch(y){s.reject(`FETCH ERROR:[${h.status}] ${h.statusText}
${y}`)}})(),{imgSource:o,needFitSize:a,ready:s}},w=new O,f=async t=>{const{ready:o,...a}=w.getOrPut(t,()=>l(t));try{await o.promise}catch(i){throw w.delete(t),i}return a},R=async(t,o,a)=>{o=Math.min(o,8192),a=Math.min(a,8192);const{imgSource:i}=await f(t),s=j(i,{width:o,height:a});return await createImageBitmap(i,{resizeWidth:s.width,resizeHeight:s.height})},g=new Set,T=[],I=async t=>{let o;if(g.size<n.length&&(o=n.find(a=>g.has(a)===!1)),o===void 0){const a=D();T.push(a),o=await a.promise}g.add(o);try{return await t(o,o.getContext("2d"))}finally{const a=T.shift();a===void 0?g.delete(o):a.resolve(o)}},U=async(t,o)=>"toDataURL"in t?await t.toDataURL(o?.type,o?.quality):await b(await t.convertToBlob(o)),B=(t,o)=>M(t,o),b=t=>new Promise((o,a)=>{const i=new FileReader;i.onload=()=>o(i.result),i.onerror=a,i.readAsDataURL(t)}),k=Object.getPrototypeOf(async function(){}).constructor,x=t=>t instanceof Blob||ArrayBuffer.isView(t)||t instanceof ArrayBuffer,L=async(t,o,a)=>{try{const i=await new k("canvasList,fetchImageBitmap,blobToDataURL,canvasToDataURL,canvasToBlob,wrapUrlByProxy",o)(n,R,b,U,B,c);let s;switch(t){case"json":s=JSON.stringify(i);break;case"binary":if(x(i))s=i;else throw new TypeError(`invalid binary type for result: ${s}`);break;case"string":s=String(i);break;default:}a(void 0,s)}catch(i){console.error(o,i),a(String(i),void 0)}};if(Object.assign(self,{evalCode:L,canvasList:n,fetchImageBitmap:R,blobToDataURL:b,canvasToBlob:B,canvasToDataURL:U,wrapUrlByProxy:c,prepareImage:f,requestCanvas:I}),r){const t=new WebSocket(r);t.onopen=()=>{console.info("ready for reander")};const o=s=>(console.log("start eval code:",s.rid,s.runCode),L(s.returnType,s.runCode,(h,y)=>{try{h===void 0?y!==void 0?(t.send(`${s.rid}:return:`),t.send(y)):t.send(`${s.rid}:void`):t.send(`${s.rid}:throw:${h}`)}catch(p){t.send(`${s.rid}:throw:${String(p)}`)}}));let a;const i=s=>{a?a=a.finally(()=>o(s)):a=o(s)};t.onmessage=s=>{const h=JSON.parse(s.data);i(h)}}})().catch(console.error);
